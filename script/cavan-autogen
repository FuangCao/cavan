#!/bin/bash

MAKEFILE_AM="Makefile.am"
CAVAN_NAME="cavan"
SUID_BINS="sudo service"

function gen_makefile_am_header()
{
	cat > ${MAKEFILE_AM} << EOF
# This file automatically generated by Fuang.Cao

AUTOMAKE_OPTIONS = foreign

MAINTAINERCLEANFILES = ${MAKEFILE_AM} Makefile.in

EOF
}

function gen_app_makefile_am()
{
	local bin_name bin_all

	cd $1 || return 1

	gen_makefile_am_header

	for fn in *.c
	do
		bin_name="${fn%.c}"
		bin_all="${CAVAN_NAME}-${bin_name} ${bin_all}"
		echo "${CAVAN_NAME}_${bin_name}_SOURCES = ${fn}"
	done >> ${MAKEFILE_AM}

	cat >> ${MAKEFILE_AM} << EOF

bin_PROGRAMS = ${bin_all}

AM_CPPFLAGS = -I@abs_top_srcdir@/include
AM_LDFLAGS = -L@abs_top_builddir@/lib/_libs -L@abs_top_builddir@/lib/.libs -Wl,-rpath -Wl,@libdir@ -l${CAVAN_NAME} -lpthread -lm -lrt

install: install-am
	for fn in ${SUID_BINS}; \\
	do \\
		chmod -f 04755 \$(DESTDIR)\$(bindir)/cavan-\$\${fn}; \\
	done
EOF

	return 0
}

function gen_lib_makefile_am()
{
	cd $1 || return 1

	gen_makefile_am_header

	cat >> ${MAKEFILE_AM} << EOF
ACLOCAL_AMFLAGS = -I m4

AM_CPPFLAGS = -I@abs_top_srcdir@/include -fPIC

lib_LTLIBRARIES = lib${CAVAN_NAME}.la
EOF
	echo lib${CAVAN_NAME}_la_SOURCES = *.c >> ${MAKEFILE_AM}

	return 0
}

function gen_include_sub_makefile_am()
{
	cd $1 || return 1

	gen_makefile_am_header

	cat >> ${MAKEFILE_AM} << EOF
cavanincdir = \$(includedir)/cavan

EOF
	echo cavaninc_HEADERS = *.h >> ${MAKEFILE_AM}

	return 0
}

function gen_include_makefile_am()
{
	cd $1 || return 1

	gen_makefile_am_header

	cat >> ${MAKEFILE_AM} << EOF
SUBDIRS = cavan

cavanincdir = \$(includedir)

EOF
	echo cavaninc_HEADERS = *.h >> ${MAKEFILE_AM}

	gen_include_sub_makefile_am $1/cavan || exit 1

	return 0
}

function get_abs_directory()
{
	cd $(dirname $1) && pwd
}

CMD_ABS_DIR="$(get_abs_directory $0)"
CAVAN_ROOT="$(dirname ${CMD_ABS_DIR})"

gen_app_makefile_am ${CAVAN_ROOT}/app || exit 1
gen_lib_makefile_am ${CAVAN_ROOT}/lib || exit 1
gen_include_makefile_am ${CAVAN_ROOT}/include || exit 1

cd ${CAVAN_ROOT} || exit 1
echo autoscan
# autoscan || exit
echo aclocal
aclocal || exit 1
echo libtoolize
libtoolize -cf || exit 1
echo automake
automake --add-missing || exit 1
echo autoheader
autoheader || exit 1
echo autoconf
autoconf || exit 1
