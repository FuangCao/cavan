#!/bin/bash

FILE_HEADER="This File Is Automatically Generated By FuangCao"
CREATE_DATE="$(date "+%Y-%m-%d %H:%M:%S")"
AUTHOR_INFO="Fuang.Cao <cavan.cfa@gmail.com> ${CREATE_DATE}"

function create_source_file()
{
	local HEADER_FILE_PATH

	case "$1" in
		app)
			FILE_TYPE="app"
			MAKE_TYPE="APP"
			cat > $2.c << EOF
// ${AUTHOR_INFO}

#include <cavan.h>

EOF
			if [ "$3" = "simple" ]
			then
				cat >> $2.c << EOF
int main(int argc, char *argv[])
{

	return 0;
}
EOF
			else
				cat >> $2.c << EOF
#define FILE_CREATE_DATE "${CREATE_DATE}"

EOF
				cat ${CAVAN_ABS_PATH}/script/core/example.c >> $2.c
			fi
			;;
		lib)
			FILE_TYPE="lib"
			MAKE_TYPE="LIB"

			if [ "$3" ]
			then
				HEADER_FILE_PATH="$3/$2.h"
			else
				HEADER_FILE_PATH="${CAVAN_ABS_PATH}/include/cavan/$2.h"
			fi

			cat > ${HEADER_FILE_PATH} << EOF
#pragma once

// ${AUTHOR_INFO}
EOF
			cat > $2.c << EOF
#include <cavan.h>
#include <cavan/$2.h>

// ${AUTHOR_INFO}
EOF
			;;
		*)
			echo "unknown source type"
			return 1
			;;
	esac
}

function create_makefile()
{
	[ "$2" ] ||
	{
		echo "please input pathname"
		return 1
	}

	[ -e "$2" ] &&
	{
		echo "directory $2 is exist"
		return 1
	}

	echo ${PWD} | grep ${CAVAN_ABS_PATH} &&
	{
		create_source_file $* || return 1
		return 0
	}

	rm $2 -rfv

	mkdir $2 && cd $2 ||
	{
		echo "can't change directory to $2"
		return 1
	}

	create_source_file $* .


cat > cavan.mk << EOF
# ${FILE_HEADER}
# ${AUTHOR_INFO}

source-${FILE_TYPE} += $2.c
EOF

cat > Makefile << EOF
CAVAN_PATH = ${CAVAN_ABS_PATH}

all:
	@+make -C \$(CAVAN_PATH) ${MAKE_TYPE}=${PWD} ${FILE_TYPE}

%:
	@+make -C \$(CAVAN_PATH) ${MAKE_TYPE}=${PWD} \$@
EOF
}

function get_file_abs_dir()
{
	cd `dirname $0` && pwd
}

CMD_ABS_DIR=`get_file_abs_dir $0`
CMD_ABS_PATH=${CMD_ABS_DIR}/`basename $0`

CAVAN_ABS_PATH=`dirname ${CMD_ABS_DIR}`

echo "============================================================"
echo "CMD_ABS_PATH = ${CMD_ABS_PATH}"
echo "CAVAN_ABS_PATH = ${CAVAN_ABS_PATH}"
echo "============================================================"

create_makefile $*
